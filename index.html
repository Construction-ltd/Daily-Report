<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Attendance Report</title>

<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
    body {
        font-family: 'Segoe UI', Arial, sans-serif;
        padding: 20px;
        background-color: #f8f9fa;
    }

    .filter-box {
        padding: 20px;
        background: white;
        margin-bottom: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
    }

    .filter-box input {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 6px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
    }

    th, td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: center;
        font-size: 14px;
    }

    th {
        background: #2196f3;
        color: white;
    }

    .btn {
        background: #2196f3;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
    }

    .btn-summary { background: #e91e63; } /* Daily report color changed to distinguish */
</style>
</head>
<body>

<h2><span class="material-icons" style="vertical-align: middle;">construction</span> Sohanur Construction Daily Report</h2>

<div class="filter-box">
    <div><label><b>Select Date:</b></label><input type="date" id="reportDate"></div>
    <div><label><b>Worker ID:</b></label><input type="text" id="workerID" placeholder="Optional"></div>
    <button class="btn" onclick="filterData()">View History</button>
    <button class="btn btn-summary" onclick="openDailyReport()">Get Daily Report</button>
</div>

<table id="dataTable">
    <thead>
        <tr>
            <th>Timestamp</th><th>Worker ID</th><th>Name</th><th>Designation</th><th>Day Salary</th><th>Date</th><th>Attended</th><th>OT</th>
        </tr>
    </thead>
    <tbody><tr><td colspan="8">Loading data...</td></tr></tbody>
</table>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQeMfVC0OT9CSn4ShLoMNqfZ3pFD5RlkS2dCj1jdfjzvvvGYWOSUy5Mr-zdQ97lb96sjnoXZh5zFaCP/pub?gid=1560298674&single=true&output=csv";
let allData = [];

fetch(CSV_URL)
    .then(res => res.text())
    .then(csv => {
        allData = csv.split("\n").map(r => r.split(",").map(c => c.replace(/"/g, "").trim()));
        allData.shift();
        loadTable(allData);
    });

function fixDate(dateText) {
    if (!dateText) return null;
    let d = dateText.split("/");
    return d.length === 3 ? new Date(`${d[2]}-${d[1]}-${d[0]}`) : new Date(dateText);
}

function loadTable(dataset) {
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";
    dataset.forEach(row => {
        if (row.length < 5) return;
        let tr = document.createElement("tr");
        row.forEach(col => { let td = document.createElement("td"); td.textContent = col; tr.appendChild(td); });
        tbody.appendChild(tr);
    });
}

// History ফিল্টার
function filterData() {
    const selectedDate = document.getElementById("reportDate").value;
    const worker = document.getElementById("workerID").value.trim();
    
    let filtered = allData.filter(row => {
        let rowDate = fixDate(row[5]);
        if (!rowDate) return false;
        
        // Single date comparison
        let dateMatch = !selectedDate || rowDate.getTime() === new Date(selectedDate).getTime();
        let workerMatch = !worker || row[1] === worker;
        
        return dateMatch && workerMatch;
    });
    loadTable(filtered);
}

// Single Date Daily Report জেনারেটর
function openDailyReport() {
    const selectedDate = document.getElementById("reportDate").value;
    if(!selectedDate) {
        alert("Please select a date first!");
        return;
    }

    let filtered = allData.filter(row => {
        let rowDate = fixDate(row[5]);
        return rowDate && rowDate.getTime() === new Date(selectedDate).getTime();
    });

    if(filtered.length === 0) {
        alert("No attendance found for this date!");
        return;
    }

    let rowsHTML = "";
    let grandTotal = 0;
    
    filtered.forEach(r => {
        let id = r[1], name = r[2], des = r[3], salary = Number(r[4]), att = Number(r[6]), ot = Number(r[7]);
        let attendSalary = att * salary;
        let otRate = salary / 8;
        let otAmount = ot * otRate;
        let total = attendSalary + otAmount;
        grandTotal += total;
        
        rowsHTML += `<tr><td>${id}</td><td>${name}</td><td>${des}</td><td>${att}</td><td>${salary}</td><td>${attendSalary.toFixed(2)}</td><td>${ot}</td><td>${otRate.toFixed(2)}</td><td>${otAmount.toFixed(2)}</td><td><b>${total.toFixed(2)}</b></td></tr>`;
    });

    let summaryWin = window.open("", "_blank");
    summaryWin.document.write(`
        <html>
        <head>
            <title>Daily Report - ${selectedDate}</title>
            <style>
                @media print { thead { display: table-header-group; } .no-print { display: none; } }
                body { font-family: 'Arial', sans-serif; padding: 10px; color: #000; }
                .company-name-top { text-align: center; font-size: 26px; font-weight: bold; margin-bottom: 5px; }
                .header-flex { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 5px; }
                .info-left { width: 60%; font-size: 13px; line-height: 1.4; }
                .logo-right { width: 40%; text-align: right; }
                .date-center { text-align: center; margin-top: 5px; font-size: 16px; font-weight: bold; border-top: 1px solid #000; border-bottom: 1px solid #000; padding: 5px 0; background: #eee; }
                table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                th, td { border: 1px solid #000; padding: 6px; text-align: center; font-size: 12px; }
                th { background: #f2f2f2 !important; font-weight: bold; }
                .total-box { margin-top: 15px; text-align: right; font-size: 16px; font-weight: bold; }
                .sig-area { margin-top: 80px; display: flex; justify-content: space-between; }
                .sig-box { border-top: 1px solid #000; width: 140px; text-align: center; font-size: 13px; }
            </style>
        </head>
        <body>
            <div class="company-name-top">SOHANUR CONSTRUCTION & MANPOWER SOLUTION</div>
            <div class="header-flex">
                <div class="info-left">
                    <div><b>Phone:</b> 01805-090910, 01805-090950</div>
                    <div><b>Email:</b> sohanurconstructionltd@gmail.com</div>
                    <div><b>Address:</b> Naogaon Sadar, Naogaon (6500)</div>
                </div>
                <div class="logo-right">
                    <img src="https://scontent.fcgp4-2.fna.fbcdn.net/v/t39.30808-6/605243562_908002708456468_4393973484981407834_n.jpg?_nc_cat=111&ccb=1-7&_nc_sid=127cfc&_nc_eui2=AeGlOhCWlvFFn-rSxXAxrYeXFalWBXYMbn8VqVYFdgxuf2bdlA_oZdUCRdnWJNqTLDlCbf116j8ZfWV61JH2zPE0&_nc_ohc=HSMMN4vEXEQQ7kNvwFwWN-A&_nc_oc=Adl8C_CNbT0BY9k22YInwOHJH8AR7Ty75zFul8FTDenntPBetaua3XiaWaIGOHIW9fY&_nc_zt=23&_nc_ht=scontent.fcgp4-2.fna&_nc_gid=DQg8oaoXLgHqqk_uskL0ZQ&oh=00_AfltHh3U7DH1bGTCqOpaP3JjfncWfxnDP9JQEo7p-nvIMA&oe=6958338C" width="100">
                </div>
            </div>

            <div class="date-center">DAILY ATTENDANCE & SALARY REPORT: ${selectedDate}</div>

            <table>
                <thead>
                    <tr>
                        <th>ID</th><th>Name</th><th>Designation</th><th>Days</th><th>Rate</th><th>Basic</th><th>OT(H)</th><th>OT Rate</th><th>OT Amt</th><th>Total</th>
                    </tr>
                </thead>
                <tbody>${rowsHTML}</tbody>
            </table>

            <div class="total-box">Daily Grand Total: ${grandTotal.toLocaleString(undefined, {minimumFractionDigits: 2})} BDT</div>

            <div class="sig-area">
                <div class="sig-box">Project engr.</div>
                <div class="sig-box">Site Foreman</div>
                <div class="sig-box">Director</div>
            </div>
            <div class="no-print" style="margin-top:20px;">
                <button onclick="window.print()" style="padding:10px 20px; background:#2196f3; color:white; border:none; border-radius:5px; cursor:pointer;">Print Daily Report</button>
            </div>
        </body>
        </html>
    `);
}
</script>
</body>
</html>
